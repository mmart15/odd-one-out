<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji Progression (Prototype)</title>
  <style>
    :root{
      --bg:#0B0F1A;
      --panel:#121A2B;
      --tile-empty:#18233A;
      --tile-border:rgba(255,255,255,0.10);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.65);
      --green:#22C55E;
      --yellow:#FBBF24;
      --gray:#334155;
      --accent:#7C3AED;
      --danger:#EF4444;
      --shadow:0 12px 40px rgba(0,0,0,0.40);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(124,58,237,.25), transparent 60%),
                  radial-gradient(900px 500px at 10% 30%, rgba(34,197,94,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }

    .app{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      background:rgba(18,26,43,.72);
      border:1px solid var(--tile-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    .title{
      display:flex;
      flex-direction:column;
      align-items:center;
      line-height:1.1;
      flex:1;
    }
    .title strong{font-size:14px; letter-spacing:.5px}
    .title span{font-size:12px; color:var(--muted)}

    .iconbtn{
      width:44px; height:44px;
      border-radius:12px;
      border:1px solid var(--tile-border);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, filter .06s ease;
    }
    .iconbtn:active{transform:scale(.98); filter:brightness(1.1)}
    .iconbtn:focus{outline:2px solid rgba(124,58,237,.55); outline-offset:2px}

    .prompt{
      text-align:center;
      color:var(--muted);
      font-size:13px;
    }

    .grid{
      background:rgba(18,26,43,.66);
      border:1px solid var(--tile-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      display:grid;
      gap:10px;
    }

    .row{
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:10px;
    }

    .tile{
      aspect-ratio:1/1;
      border-radius:14px;
      border:1px solid var(--tile-border);
      background:var(--tile-empty);
      display:grid;
      place-items:center;
      font-size:26px;
      line-height:1;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.15);
      transition: transform .12s ease, background .18s ease, border-color .18s ease, filter .18s ease;
    }

    .tile.pop{ animation: pop .10s ease-out; }
    @keyframes pop { from { transform:scale(.92);} to { transform:scale(1);} }

    .tile.green{ background:var(--green); border-color:transparent; color:white; }
    .tile.yellow{ background:var(--yellow); border-color:transparent; color:white; }
    .tile.gray{ background:var(--gray); border-color:transparent; color:white; }

    .kbd{
      background:rgba(18,26,43,.66);
      border:1px solid var(--tile-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .bank{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:10px;
    }

    .key{
      height:54px;
      border-radius:14px;
      border:1px solid var(--tile-border);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      display:grid;
      place-items:center;
      font-size:26px;
      cursor:pointer;
      user-select:none;
      position:relative;
      transition: transform .06s ease, filter .06s ease, box-shadow .18s ease;
      min-width:44px;
    }
    .key:active{ transform:scale(.98); filter:brightness(1.12); }
    .key[aria-disabled="true"]{ opacity:.45; cursor:not-allowed; }

    .key::after{
      content:"";
      position:absolute;
      left:12px; right:12px;
      bottom:8px;
      height:4px;
      border-radius:999px;
      background:transparent;
      opacity:.95;
    }
    .key.kg::after{ background:var(--green); }
    .key.ky::after{ background:var(--yellow); }
    .key.kx::after{ background:var(--gray); }

    .controls{
      display:grid;
      grid-template-columns:1fr 1fr 1.2fr;
      gap:10px;
    }

    .btn{
      height:46px;
      border-radius:14px;
      border:1px solid var(--tile-border);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      font-weight:650;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, filter .06s ease;
      min-width:44px;
    }
    .btn:active{ transform:scale(.98); filter:brightness(1.1); }
    .btn.primary{ background:var(--accent); border-color:transparent; }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .footer{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      padding:0 4px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(10,14,26,.85);
      border:1px solid var(--tile-border);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .14s ease, transform .14s ease;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    .modalBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      backdrop-filter: blur(6px);
    }
    .modalBackdrop.show{ display:flex; }

    .modal{
      width:min(520px, 100%);
      background:rgba(18,26,43,.92);
      border:1px solid var(--tile-border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .modalHeader strong{ font-size:14px; }
    .modalBody{ color:var(--text); font-size:13px; }
    .modalBody p{ margin:10px 0; color:var(--muted); }
    .modalActions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    .miniGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
    }
    .miniTile{
      aspect-ratio:1/1;
      border-radius:12px;
      border:1px solid var(--tile-border);
      background:var(--tile-empty);
      display:grid;
      place-items:center;
      font-size:20px;
    }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="Emoji Progression">
    <div class="topbar">
      <button class="iconbtn" id="helpBtn" aria-label="Help">?</button>
      <div class="title">
        <strong>EMOJI PROGRESSION</strong>
        <span id="subtitle">Daily Puzzle</span>
      </div>
      <button class="iconbtn" id="statsBtn" aria-label="Stats">â˜…</button>
    </div>

    <div class="prompt" id="promptLine">Build the progression.</div>

    <div class="grid" id="grid" aria-label="Guesses grid"></div>

    <div class="kbd" aria-label="Keyboard">
      <div class="bank" id="bankRow" aria-label="Emoji bank"></div>
      <div class="controls">
        <button class="btn" id="backBtn" aria-label="Backspace">âŒ«</button>
        <button class="btn" id="clearBtn" aria-label="Clear">Clear</button>
        <button class="btn primary" id="submitBtn" aria-label="Submit" disabled>Submit</button>
      </div>
    </div>

    <div class="footer">
      <div id="streakLabel">Streak: 0</div>
      <div id="countdownLabel">Next: --:--:--</div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Help Modal -->
  <div class="modalBackdrop" id="helpModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Help">
      <div class="modalHeader">
        <strong>How to play</strong>
        <button class="iconbtn" data-close="helpModal" aria-label="Close">âœ•</button>
      </div>
      <div class="modalBody">
        <p>Pick 5 emojis from todayâ€™s bank to match the hidden progression.</p>
        <p><b>ðŸŸ©</b> correct emoji in correct spot â€¢ <b>ðŸŸ¨</b> in answer but wrong spot â€¢ <b>â¬›</b> not in answer</p>
        <p>No duplicates per guess in this prototype.</p>
      </div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div class="modalBackdrop" id="statsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Stats">
      <div class="modalHeader">
        <strong>Stats</strong>
        <button class="iconbtn" data-close="statsModal" aria-label="Close">âœ•</button>
      </div>
      <div class="modalBody" id="statsBody"></div>
    </div>
  </div>

  <!-- End Modal -->
  <div class="modalBackdrop" id="endModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Result">
      <div class="modalHeader">
        <strong id="endTitle">Result</strong>
        <button class="iconbtn" data-close="endModal" aria-label="Close">âœ•</button>
      </div>
      <div class="modalBody">
        <div id="endSub" style="color:var(--muted)"></div>
        <div class="miniGrid" id="answerMini"></div>
        <div class="modalActions">
          <button class="btn primary" id="shareBtn">Share</button>
          <button class="btn" data-close="endModal">Close</button>
        </div>
        <p style="margin-top:10px;">Thanks for playing â€” come back tomorrow.</p>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- Puzzle pack (curated prototypes; add more easily) ----------
  const PACK = [
    { bank: ["ðŸŒ±","ðŸŒ¿","ðŸŒ³","ðŸŽ","ðŸ‚","ðŸŒ¾","ðŸƒ"], answer: ["ðŸŒ±","ðŸŒ¿","ðŸŒ³","ðŸŽ","ðŸ‚"] },
    { bank: ["ðŸ§Š","ðŸ’§","â˜ï¸","ðŸŒ§ï¸","ðŸŒˆ","ðŸ”¥","â„ï¸"], answer: ["ðŸ§Š","ðŸ’§","â˜ï¸","ðŸŒ§ï¸","ðŸŒˆ"] },
    { bank: ["ðŸª¨","â›ï¸","ðŸ§±","ðŸ ","ðŸ™ï¸","ðŸ°","ðŸŒ‹"], answer: ["ðŸª¨","â›ï¸","ðŸ§±","ðŸ ","ðŸ™ï¸"] },
    { bank: ["ðŸ¥š","ðŸ£","ðŸ¥","ðŸ”","ðŸ—","ðŸ¦Š","ðŸŒ½"], answer: ["ðŸ¥š","ðŸ£","ðŸ¥","ðŸ”","ðŸ—"] },
    { bank: ["ðŸŒ‘","ðŸŒ’","ðŸŒ“","ðŸŒ”","ðŸŒ•","â­","â˜„ï¸"], answer: ["ðŸŒ‘","ðŸŒ’","ðŸŒ“","ðŸŒ”","ðŸŒ•"] },
    { bank: ["ðŸ“Ž","ðŸ“„","ðŸ“š","ðŸŽ“","ðŸ’¼","ðŸ§¨","ðŸ–Šï¸"], answer: ["ðŸ“Ž","ðŸ“„","ðŸ“š","ðŸŽ“","ðŸ’¼"] },
    { bank: ["ðŸ¥‰","ðŸ¥ˆ","ðŸ¥‡","ðŸ†","ðŸ‘‘","ðŸ§¸","ðŸŽ¯"], answer: ["ðŸ¥‰","ðŸ¥ˆ","ðŸ¥‡","ðŸ†","ðŸ‘‘"] },
    { bank: ["ðŸªµ","ðŸªš","ðŸ”¨","ðŸª‘","ðŸ ","ðŸ§¯","ðŸ§²"], answer: ["ðŸªµ","ðŸªš","ðŸ”¨","ðŸª‘","ðŸ "] },
  ];

  // ---------- Deterministic daily selection ----------
  function pad2(n){ return String(n).padStart(2,"0"); }
  function todayIdLocal(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  // Simple seeded hash -> index
  function hashStr(s){
    let h = 2166136261;
    for (let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function pickDailyPuzzle(puzzleId){
    const salt = "EMOJI_PROG_V1_SALT";
    const h = hashStr(puzzleId + "|" + salt);
    const idx = h % PACK.length;
    return { id: puzzleId, number: (h % 999) + 1, ...PACK[idx] };
  }

  // ---------- Wordle-accurate feedback (count-safe) ----------
  function computeFeedback(answer, guess){
    const fb = Array(5).fill("GRAY");
    const used = Array(5).fill(false);

    // Greens
    for (let i=0;i<5;i++){
      if (guess[i] === answer[i]){
        fb[i] = "GREEN";
        used[i] = true;
      }
    }
    // Yellows
    for (let i=0;i<5;i++){
      if (fb[i] === "GREEN") continue;
      const g = guess[i];
      let found = -1;
      for (let j=0;j<5;j++){
        if (used[j]) continue;
        if (answer[j] === g){ found = j; break; }
      }
      if (found !== -1){
        fb[i] = "YELLOW";
        used[found] = true;
      }
    }
    return fb;
  }

  function fbToSquaresRow(fb){
    return fb.map(t => t==="GREEN" ? "ðŸŸ©" : t==="YELLOW" ? "ðŸŸ¨" : "â¬›").join("");
  }

  // ---------- Storage ----------
  const LS_KEY = "emoji_progression_state_v0";
  function safeParse(json){
    try { return JSON.parse(json); } catch { return null; }
  }

  function defaultState(puzzleId){
    return {
      puzzleId,
      attempts: [],           // { guess:[5], feedback:[5] }
      currentGuess: [],
      status: "IN_PROGRESS", // WON | LOST
      stats: {
        played: 0,
        wins: 0,
        currentStreak: 0,
        maxStreak: 0,
        guessDist: [0,0,0,0,0,0],
        lastPlayedPuzzleId: null,
        lastWinPuzzleId: null
      }
    };
  }

  function loadState(todayId){
    const raw = localStorage.getItem(LS_KEY);
    const parsed = raw ? safeParse(raw) : null;
    if (!parsed || typeof parsed !== "object") return defaultState(todayId);

    // If puzzle day changed, carry stats but reset game
    if (parsed.puzzleId !== todayId){
      const next = defaultState(todayId);
      if (parsed.stats) next.stats = parsed.stats;
      return next;
    }
    // basic shape checks
    if (!Array.isArray(parsed.attempts)) parsed.attempts = [];
    if (!Array.isArray(parsed.currentGuess)) parsed.currentGuess = [];
    if (!parsed.stats || !Array.isArray(parsed.stats.guessDist)) parsed.stats = defaultState(todayId).stats;
    return parsed;
  }

  function saveState(state){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  // ---------- UI refs ----------
  const els = {
    subtitle: document.getElementById("subtitle"),
    grid: document.getElementById("grid"),
    bankRow: document.getElementById("bankRow"),
    backBtn: document.getElementById("backBtn"),
    clearBtn: document.getElementById("clearBtn"),
    submitBtn: document.getElementById("submitBtn"),
    toast: document.getElementById("toast"),
    streakLabel: document.getElementById("streakLabel"),
    countdownLabel: document.getElementById("countdownLabel"),
    helpBtn: document.getElementById("helpBtn"),
    statsBtn: document.getElementById("statsBtn"),
    helpModal: document.getElementById("helpModal"),
    statsModal: document.getElementById("statsModal"),
    statsBody: document.getElementById("statsBody"),
    endModal: document.getElementById("endModal"),
    endTitle: document.getElementById("endTitle"),
    endSub: document.getElementById("endSub"),
    answerMini: document.getElementById("answerMini"),
    shareBtn: document.getElementById("shareBtn"),
  };

  // ---------- App state ----------
  const todayId = todayIdLocal();
  const puzzle = pickDailyPuzzle(todayId);
  let state = loadState(todayId);

  // ---------- Helpers ----------
  let toastTimer = null;
  function toast(msg){
    clearTimeout(toastTimer);
    els.toast.textContent = msg;
    els.toast.classList.add("show");
    toastTimer = setTimeout(() => els.toast.classList.remove("show"), 1200);
  }

  function bestTile(a,b){
    const rank = { GRAY:1, YELLOW:2, GREEN:3 };
    return rank[b] > rank[a] ? b : a;
  }

  function getKeyStatuses(){
    const map = new Map();
    for (const e of puzzle.bank) map.set(e, ""); // none
    for (const att of state.attempts){
      for (let i=0;i<5;i++){
        const e = att.guess[i];
        const t = att.feedback[i];
        if (!map.has(e)) continue;
        const prev = map.get(e) || "";
        if (!prev) map.set(e, t);
        else map.set(e, bestTile(prev, t));
      }
    }
    return map;
  }

  function canSubmit(){
    return state.status === "IN_PROGRESS" && state.currentGuess.length === 5;
  }

  function hasDuplicates(arr){
    return new Set(arr).size !== arr.length;
  }

  // ---------- Rendering ----------
  function render(){
    els.subtitle.textContent = `#${String(puzzle.number).padStart(3,"0")} â€¢ ${puzzle.id}`;
    els.streakLabel.textContent = `Streak: ${state.stats.currentStreak}`;

    // Grid
    els.grid.innerHTML = "";
    for (let r=0;r<6;r++){
      const row = document.createElement("div");
      row.className = "row";
      const attempt = state.attempts[r] || null;
      for (let c=0;c<5;c++){
        const tile = document.createElement("div");
        tile.className = "tile";
        let emoji = "";
        if (attempt){
          emoji = attempt.guess[c] || "";
          const fb = attempt.feedback[c];
          if (fb === "GREEN") tile.classList.add("green");
          else if (fb === "YELLOW") tile.classList.add("yellow");
          else tile.classList.add("gray");
        } else if (r === state.attempts.length){
          emoji = state.currentGuess[c] || "";
        }
        tile.textContent = emoji;
        row.appendChild(tile);
      }
      els.grid.appendChild(row);
    }

    // Bank keys
    const keyStatus = getKeyStatuses();
    els.bankRow.innerHTML = "";
    puzzle.bank.forEach((e) => {
      const k = document.createElement("button");
      k.className = "key";
      k.setAttribute("type","button");
      k.setAttribute("aria-label", `Emoji ${e}`);
      k.textContent = e;

      const st = keyStatus.get(e);
      if (st === "GREEN") k.classList.add("kg");
      else if (st === "YELLOW") k.classList.add("ky");
      else if (st === "GRAY") k.classList.add("kx");

      // disable if already selected or game ended
      const disabled = state.status !== "IN_PROGRESS" || state.currentGuess.includes(e);
      if (disabled) k.setAttribute("aria-disabled","true");

      k.addEventListener("click", () => onEmoji(e));
      els.bankRow.appendChild(k);
    });

    els.submitBtn.disabled = !canSubmit();
  }

  function openModal(el){
    el.classList.add("show");
    el.setAttribute("aria-hidden","false");
  }
  function closeModal(el){
    el.classList.remove("show");
    el.setAttribute("aria-hidden","true");
  }

  function renderStats(){
    const s = state.stats;
    const played = s.played || 0;
    const wins = s.wins || 0;
    const winPct = played ? Math.round((wins/played)*100) : 0;

    const dist = (s.guessDist || [0,0,0,0,0,0])
      .map((n,i) => `<div style="display:flex;align-items:center;gap:10px;margin:6px 0;">
          <div style="width:18px;color:var(--muted)">${i+1}</div>
          <div style="flex:1;background:rgba(255,255,255,0.07);border:1px solid var(--tile-border);border-radius:999px;overflow:hidden;">
            <div style="height:10px;width:${played? Math.max(6, (n/Math.max(1,Math.max(...s.guessDist)))*100):0}%;background:var(--accent)"></div>
          </div>
          <div style="width:24px;text-align:right;color:var(--muted)">${n}</div>
        </div>`).join("");

    els.statsBody.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:6px;">
        <div style="background:rgba(255,255,255,0.04);border:1px solid var(--tile-border);border-radius:14px;padding:10px;text-align:center;">
          <div style="font-weight:800;font-size:16px">${played}</div>
          <div style="color:var(--muted);font-size:12px">Played</div>
        </div>
        <div style="background:rgba(255,255,255,0.04);border:1px solid var(--tile-border);border-radius:14px;padding:10px;text-align:center;">
          <div style="font-weight:800;font-size:16px">${winPct}</div>
          <div style="color:var(--muted);font-size:12px">Win %</div>
        </div>
        <div style="background:rgba(255,255,255,0.04);border:1px solid var(--tile-border);border-radius:14px;padding:10px;text-align:center;">
          <div style="font-weight:800;font-size:16px">${s.currentStreak||0}</div>
          <div style="color:var(--muted);font-size:12px">Streak</div>
        </div>
        <div style="background:rgba(255,255,255,0.04);border:1px solid var(--tile-border);border-radius:14px;padding:10px;text-align:center;">
          <div style="font-weight:800;font-size:16px">${s.maxStreak||0}</div>
          <div style="color:var(--muted);font-size:12px">Max</div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div style="font-weight:800;margin-bottom:6px;">Guess distribution</div>
        ${dist}
      </div>
    `;
  }

  // ---------- Game actions ----------
  function onEmoji(e){
    if (state.status !== "IN_PROGRESS") return;
    if (state.currentGuess.length >= 5) return;
    if (state.currentGuess.includes(e)) return;
    state.currentGuess.push(e);
    saveState(state);
    render();

    // pop animation on current row tiles
    const rowIndex = state.attempts.length;
    const row = els.grid.children[rowIndex];
    if (row){
      const tile = row.children[state.currentGuess.length-1];
      if (tile){
        tile.classList.add("pop");
        setTimeout(()=>tile.classList.remove("pop"), 140);
      }
    }
  }

  function onBack(){
    if (state.status !== "IN_PROGRESS") return;
    state.currentGuess.pop();
    saveState(state);
    render();
  }

  function onClear(){
    if (state.status !== "IN_PROGRESS") return;
    state.currentGuess = [];
    saveState(state);
    render();
  }

  function endGame(status){
    state.status = status;

    // Stats update only once per puzzle end
    const s = state.stats;
    const alreadyCounted = (s.lastPlayedPuzzleId === puzzle.id);
    if (!alreadyCounted){
      s.played = (s.played||0) + 1;
      s.lastPlayedPuzzleId = puzzle.id;

      if (status === "WON"){
        s.wins = (s.wins||0) + 1;

        // streak logic (simple: if last win was yesterday, continue)
        const d = new Date(puzzle.id + "T00:00:00");
        const y = new Date(d);
        y.setDate(d.getDate()-1);
        const yesterdayId = `${y.getFullYear()}-${pad2(y.getMonth()+1)}-${pad2(y.getDate())}`;

        if (s.lastWinPuzzleId === yesterdayId) s.currentStreak = (s.currentStreak||0) + 1;
        else s.currentStreak = 1;

        s.maxStreak = Math.max(s.maxStreak||0, s.currentStreak||0);

        const attemptsUsed = state.attempts.len
